<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HSK: доска визуализации</title>
  <style>
    :root{
      --bg:#0f1220;
      --card:#171b2e;
      --muted:#9aa3b2;
      --grid-gap:6px;
      --radius:12px;
      --known:#2e7d32;
      --unknown:#394264;
      --level1:#f9d264; --level2:#5db4c7; --level3:#f58052;
      --level4:#dd4b4b; --level5:#274d7c; --level6:#6a4c9c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background:linear-gradient(180deg,#0b0e1a,#0f1220 40%);
      color:#e7ecf3;
      -webkit-font-smoothing:antialiased;
      padding: clamp(12px, 2vw, 20px);
    }
    header{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px;
    }
    h1{font-size:clamp(22px,4vw,30px); margin:0; letter-spacing:.5px}
    .bar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .pill{
      background:var(--card); color:#fff; border:1px solid #232949; border-radius:999px;
      padding:8px 12px; display:inline-flex; align-items:center; gap:8px; line-height:1;
    }
    .pill input, .pill select{background:transparent; border:0; color:#fff; outline:0}
    button{
      background:#2a3160; border:1px solid #3c4480; padding:10px 14px; border-radius:10px; color:#fff; cursor:pointer;
    }
    button:hover{filter:brightness(1.1)}
    .legend{display:flex; gap:8px; flex-wrap:wrap}
    .badge{display:flex; align-items:center; gap:6px; background:#1b2040; border:1px solid #283062; border-radius:999px; padding:6px 10px; font-size:12px; color:#cfd6e6}
    .dot{width:12px; height:12px; border-radius:3px}
    .grid{
      display:grid; gap:var(--grid-gap);
      grid-template-columns: repeat(auto-fill, minmax(42px, 1fr));
      align-items:stretch;
    }
    .cell{
      aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
      background:var(--unknown);
      border:1px solid #46507a;
      border-radius:10px; font-size:20px; user-select:none; position:relative; cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow: 0 0 0 0 rgba(0,0,0,0);
    }
    .cell:active{ transform: scale(.98) }
    .cell[data-known="1"]{ background:var(--known); border-color:#49a34e }
    .cell[data-level="1"]{ --unknown:var(--level1) }
    .cell[data-level="2"]{ --unknown:var(--level2) }
    .cell[data-level="3"]{ --unknown:var(--level3) }
    .cell[data-level="4"]{ --unknown:var(--level4) }
    .cell[data-level="5"]{ --unknown:var(--level5) }
    .cell[data-level="6"]{ --unknown:var(--level6) }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px}
    .stats{font-size:14px; color:var(--muted)}
    dialog::backdrop{background:rgba(5,8,20,.5); backdrop-filter: blur(2px)}
    dialog{
      border:1px solid #2f3869; background:var(--card); color:#fff; border-radius:16px;
      padding:14px; max-width:480px; width:calc(100% - 32px);
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .sheet-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .han{font-size:48px; line-height:1}
    .meta{display:flex; flex-direction:column; gap:4px; color:#cfd6e6}
    .meta b{color:#fff}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .sr-only{position:absolute; left:-9999px}
    .empty{padding:30px; text-align:center; color:#9aa3b2; border:1px dashed #303760; border-radius:12px}
    .footer-note{margin-top:12px; color:#9aa3b2; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>HSK: доска визуализации</h1>
    <div class="bar">
      <label class="pill">Уровень:
        <select id="levelFilter">
          <option value="all">все</option>
          <option value="1">HSK1</option>
          <option value="2">HSK2</option>
          <option value="3">HSK3</option>
          <option value="4">HSK4</option>
          <option value="5">HSK5</option>
          <option value="6">HSK6</option>
        </select>
      </label>
      <label class="pill">Поиск:
        <input id="searchBox" placeholder="汉字 / pinyin / перевод" />
      </label>
      <button id="importCsvBtn">Импорт CSV</button>
      <button id="exportBtn">Экспорт прогресса</button>
      <button id="resetBtn" title="Сбросить отметки">Сброс</button>
    </div>
  </header>

  <div class="legend">
    <span class="badge"><span class="dot" style="background:var(--level1)"></span>HSK1</span>
    <span class="badge"><span class="dot" style="background:var(--level2)"></span>HSK2</span>
    <span class="badge"><span class="dot" style="background:var(--level3)"></span>HSK3</span>
    <span class="badge"><span class="dot" style="background:var(--level4)"></span>HSK4</span>
    <span class="badge"><span class="dot" style="background:var(--level5)"></span>HSK5</span>
    <span class="badge"><span class="dot" style="background:var(--level6)"></span>HSK6</span>
  </div>

  <div class="toolbar stats" id="stats"></div>

  <div id="grid" class="grid" role="list"></div>

  <dialog id="sheet">
    <div class="sheet-header">
      <div class="han" id="d-han">好</div>
      <div class="meta">
        <div><b>Пиньинь:</b> <span id="d-py"></span></div>
        <div><b>Перевод:</b> <span id="d-tr"></span></div>
        <div><b>Уровень:</b> <span id="d-level"></span></div>
      </div>
      <button id="closeBtn" aria-label="Закрыть">✕</button>
    </div>
    <div class="actions">
      <button id="toggleKnownBtn">Отметить как выучено</button>
      <button id="copyBtn">Скопировать</button>
    </div>
  </dialog>

  <input type="file" id="fileInput" class="sr-only" accept=".csv,text/csv" />

  <p class="footer-note">
    Подсказка: нажми на любой иероглиф, чтобы открыть карточку. Отметки сохраняются на устройстве (localStorage).
  </p>

<script>
// --- Data loading ---
const sampleCSV = `level,han,pinyin,ru
1,上,shàng,подниматься; на
1,不,bù,не
1,个,gè,счётное слово
1,书,shū,книга
1,买,mǎi,покупать
1,了,le,глагольный суффикс
1,些,xiē,несколько
1,人,rén,человек
1,他,tā,он
1,会,huì,уметь; встреча
1,住,zhù,жить
1,你,nǐ,ты
1,做,zuò,делать
1,写,xiě,писать
1,冷,lěng,холодный
1,几,jǐ,сколько
1,去,qù,идти
1,叫,jiào,звать; называться
1,号,hào,число; дата
1,吃,chī,есть; кушать
1,吗,ma,вопросительная частица
1,听,tīng,слушать
1,呢,ne,вопросительная частица
1,和,hé,и; с
1,哪,nǎ,какой
1,喂,wèi,алло
1,喝,hē,пить
1,回,huí,возвращаться
1,在,zài,в; находиться
1,坐,zuò,сидеть
1,块,kuài,счётное слово для денег; кусок
1,多,duō,много
1,大,dà,большой
1,太,tài,слишком
1,她,tā,она
1,好,hǎo,хороший
1,字,zì,иероглиф; слово
1,家,jiā,дом; семья
1,小,xiǎo,маленький
1,少,shǎo,мало
1,岁,suì,годы (возраст)
1,年,nián,год
1,开,kāi,открывать; начинать
1,很,hěn,очень
1,想,xiǎng,думать; хотеть
1,我,wǒ,я
1,是,shì,быть (являться)
1,月,yuè,месяц; луна
1,有,yǒu,иметь; есть
1,本,běn,счётное слово для книг
1,来,lái,приходить
1,水,shuǐ,вода
1,点,diǎn,немного; точка
1,热,rè,горячий
1,爱,ài,любить
1,狗,gǒu,собака
1,猫,māo,кошка
1,的,de,притяжательная частица
1,看,kàn,смотреть; читать
1,能,néng,мочь
1,茶,chá,чай
1,菜,cài,овощи; блюдо
1,说,shuō,говорить
1,请,qǐng,пожалуйста; просить
1,读,dú,читать
1,谁,shéi/shuí,кто
1,这,zhè,этот
1,那,nà,тот
1,都,dōu,все
1,里,lǐ,внутри
1,钱,qián,деньги
1,一,yī,один
1,七,qī,семь
1,三,sān,три
1,下,xià,спускаться; под
1,九,jiǔ,девять
1,二,èr,два
1,五,wǔ,пять
1,八,bā,восемь
1,六,liù,шесть
1,十,shí,десять
1,四,sì,четыре
1,上午,shàngwǔ,до полудня
1,下午,xiàwǔ,после полудня
1,下雨,xiàyǔ,идёт дождь
1,东西,dōngxi,вещь; предмет
1,中午,zhōngwǔ,полдень
1,中国,Zhōngguó,Китай
1,什么,shénme,что
1,今天,jīntiān,сегодня
1,儿子,érzi,сын
1,先生,xiānsheng,господин; учитель
1,再见,zàijiàn,до свидания
1,分钟,fēnzhōng,минута
1,前面,qiánmiàn,спереди; перед
1,北京,Běijīng,Пекин
1,医生,yīshēng,врач
1,医院,yīyuàn,больница
1,同学,tóngxué,одноклассник; соученик
1,名字,míngzi,имя
1,后面,hòumiàn,сзади; позади
1,哪儿,nǎr,где
1,商店,shāngdiàn,магазин
1,喜欢,xǐhuan,нравиться
1,多少,duōshao,сколько
1,天气,tiānqì,погода
1,女儿,nǚ'ér,дочь
1,妈妈,māma,мама
1,学习,xuéxí,учиться
1,学校,xuéxiào,школа
1,学生,xuéshēng,ученик; студент
1,小姐,xiǎojie,мисс; девушка
1,工作,gōngzuò,работа; работать
1,怎么,zěnme,как
1,我们,wǒmen,мы
1,时候,shíhou,время; момент
1,明天,míngtiān,завтра
1,星期,xīngqī,неделя
1,昨天,zuótiān,вчера
1,朋友,péngyou,друг
1,杯子,bēizi,чашка; стакан
1,桌子,zhuōzi,стол
1,椅子,yǐzi,стул
1,水果,shuǐguǒ,фрукты
1,汉语,Hànyǔ,китайский язык
1,没有,méiyǒu,не иметь; нет
1,漂亮,piàoliang,красивый
1,爸爸,bàba,папа
1,现在,xiànzài,сейчас
1,电影,diànyǐng,кино
1,电视,diànshì,телевизор
1,电脑,diànnǎo,компьютер
1,看见,kànjiàn,увидеть
1,睡觉,shuìjiào,спать
1,米饭,mǐfàn,варёный рис
1,老师,lǎoshī,учитель
1,苹果,píngguǒ,яблоко
1,衣服,yīfu,одежда
1,认识,rènshi,знать; быть знакомым
1,谢谢,xièxie,спасибо
1,飞机,fēijī,самолёт
1,饭店,fàndiàn,ресторан; гостиница
1,高兴,gāoxìng,радоваться
1,一点儿,yīdiǎnr,немного; чуть-чуть
1,不客气,bú kèqi,не за что
1,出租车,chūzūchē,такси
1,对不起,duìbuqǐ,извините
1,怎么样,zěnmeyàng,как?; каков?
1,打电话,dǎ diànhuà,звонить по телефону
1,没关系,méi guānxi,ничего страшного
2,两,liǎng,два
2,也,yě,тоже
2,从,cóng,от; из
2,件,jiàn,счётное слово для вещей
2,再,zài,снова; ещё раз
2,最,zuì,самый
2,出,chū,выходить
2,别,bié,не (повелительное)
2,到,dào,прибывать; до
2,千,qiān,тысяча
2,吧,ba,модальная частица
2,外,wài,внешний; снаружи
2,女,nǚ,женщина
2,姓,xìng,фамилия
2,它,tā,оно (для животных/вещей)
2,完,wán,заканчивать
2,对,duì,правильный; к
2,对,duì,пара
2,就,jiù,именно; тогда
2,往,wǎng,направляться к
2,得,de,структурная частица
2,忙,máng,быть занятым
2,快,kuài,быстрый
2,您,nín,Вы (вежливая форма)
2,慢,màn,медленный
2,懂,dǒng,понимать
2,找,zhǎo,искать
2,新,xīn,новый
2,日,rì,день; солнце
2,晴,qíng,ясный (о погоде)
2,次,cì,раз (счётное слово)
2,每,měi,каждый
2,比,bǐ,сравнивать
2,洗,xǐ,мыть; стирать
2,男,nán,мужчина
2,白,bái,белый
2,百,bǎi,сто
2,真,zhēn,настоящий; действительно
2,着,zhe,суффикс продолженного вида
2,票,piào,билет
2,离,lí,отстоять от
2,穿,chuān,носить (одежду)
2,笑,xiào,смеяться
2,等,děng,ждать
2,红,hóng,красный
2,给,gěi,давать
2,药,yào,лекарство
2,要,yào,хотеть; нужно
2,让,ràng,позволять
2,课,kè,урок
2,贵,guì,дорогой
2,走,zǒu,идти
2,路,lù,дорога
2,过,guò,проходить; переживать
2,近,jìn,близкий
2,还,hái,ещё
2,进,jìn,входить
2,远,yuǎn,далёкий
2,送,sòng,провожать; дарить
2,错,cuò,ошибка; неправильный
2,长,cháng,длинный
2,门,mén,дверь
2,问,wèn,спрашивать
2,阴,yīn,пасмурный
2,雪,xuě,снег
2,零,líng,ноль
2,题,tí,вопрос; задача
2,高,gāo,высокий
2,鱼,yú,рыба
2,黑,hēi,чёрный
2,卖,mài,продавать
2,玩,wán,играть
2,累,lèi,усталый
2,一下,yīxià,немного; короткое время
2,一起,yīqǐ,вместе
2,丈夫,zhàngfu,муж
2,上班,shàngbān,идти на работу
2,事情,shìqing,дело; вопрос
2,介绍,jièshào,представлять
2,休息,xiūxi,отдыхать
2,便宜,piányi,дешёвый
2,公司,gōngsī,компания
2,准备,zhǔnbèi,готовить; подготовка
2,去年,qùnián,прошлый год
2,可以,kěyǐ,можно
2,可能,kěnéng,возможно
2,右边,yòubian,правая сторона
2,告诉,gàosu,сообщать
2,咖啡,kāfēi,кофе
2,哥哥,gēge,старший брат
2,唱歌,chànggē,петь песни
2,大家,dàjiā,все
2,好吃,hǎochī,вкусный
2,妹妹,mèimei,младшая сестра
2,妻子,qīzi,жена
2,姐姐,jiějie,старшая сестра
2,孩子,háizi,ребёнок
2,宾馆,bīnguǎn,гостиница
2,小时,xiǎoshí,час
2,左边,zuǒbian,левая сторона
2,已经,yǐjīng,уже
2,希望,xīwàng,надеяться; надежда
2,帮助,bāngzhù,помогать; помощь
2,开始,kāishǐ,начинать; начало
2,弟弟,dìdi,младший брат
2,快乐,kuàilè,счастливый
2,意思,yìsi,значение; смысл
2,房间,fángjiān,комната
2,手机,shǒujī,мобильный телефон
2,手表,shǒubiǎo,наручные часы
2,报纸,bàozhǐ,газета
2,教室,jiàoshì,класс; аудитория
2,旁边,pángbiān,рядом
2,旅游,lǚyóu,путешествовать
2,早上,zǎoshang,утро
2,时间,shíjiān,время
2,晚上,wǎnshang,вечер
2,机场,jīchǎng,аэропорт
2,正在,zhèngzài,в процессе (чего-либо)
2,游泳,yóuyǒng,плавать
2,牛奶,niúnǎi,молоко
2,生日,shēngrì,день рождения
2,生病,shēngbìng,болеть
2,眼睛,yǎnjing,глаза
2,知道,zhīdào,знать
2,第一,dì-yī,первый
2,羊肉,yángròu,баранина
2,考试,kǎoshì,экзамен
2,西瓜,xīguā,арбуз
2,觉得,juéde,чувствовать; считать
2,说话,shuōhuà,разговаривать
2,起床,qǐchuáng,вставать с постели
2,跑步,pǎobù,бегать
2,跳舞,tiàowǔ,танцевать
2,身体,shēntǐ,тело
2,运动,yùndòng,спорт; движение
2,铅笔,qiānbǐ,карандаш
2,问题,wèntí,вопрос; проблема
2,非常,fēicháng,очень
2,面条,miàntiáo,лапша
2,颜色,yánsè,цвет
2,鸡蛋,jīdàn,яйцо
2,为什么,wèishénme,почему
2,打篮球,dǎ lánqiú,играть в баскетбол
2,服务员,fúwùyuán,официант; обслуживающий персонал
2,火车站,huǒchēzhàn,железнодорожный вокзал
2,踢足球,tī zúqiú,играть в футбол
2,公共汽车,gōnggòng qìchē,автобус
2,因为所以,yīnwèi suǒyǐ,потому что... поэтому...
2,虽然但是,suīrán dànshì,хотя... но...
3,万,wàn,десять тысяч
... (оставшиеся строки уровня 3 и 4 — как прислал пользователь) ...
4,高速公路,gāosù gōnglù,автострада
`;

// Parse CSV to array of records
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(s=>s.trim());
  return lines.map(line=>{
    const parts = []; let current=""; let inQuotes=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='\"'){ inQuotes=!inQuotes; continue; }
      if(ch===',' && !inQuotes){ parts.push(current); current=""; continue; }
      current+=ch;
    }
    parts.push(current);
    const obj={};
    headers.forEach((h,idx)=>obj[h]= (parts[idx]||"").trim());
    obj.level = String(obj.level||"").trim();
    return obj;
  });
}

const STATE_KEY = "hsk_known_v1";
const state = {
  known: new Set(JSON.parse(localStorage.getItem(STATE_KEY) || "[]"))
};

let data = [];
let filtered = [];

// Try to fetch external hsk.csv; otherwise use sample
async function loadData(){
  try{
    const r = await fetch("hsk.csv", {cache:"no-store"});
    if(r.ok){
      const t = await r.text();
      data = parseCSV(t);
    } else {
      data = parseCSV(sampleCSV);
    }
  }catch(e){
    data = parseCSV(sampleCSV);
  }
  render();
}
loadData();

// --- UI & interactions ---
const grid = document.getElementById("grid");
const stats = document.getElementById("stats");
const levelFilter = document.getElementById("levelFilter");
const searchBox = document.getElementById("searchBox");
const sheet = document.getElementById("sheet");
const dHan = document.getElementById("d-han");
const dPy = document.getElementById("d-py");
const dTr = document.getElementById("d-tr");
const dLevel = document.getElementById("d-level");
const toggleKnownBtn = document.getElementById("toggleKnownBtn");
const copyBtn = document.getElementById("copyBtn");
const closeBtn = document.getElementById("closeBtn");

let currentItem = null;

function render(){
  const level = levelFilter.value;
  const q = (searchBox.value||"").toLowerCase().trim();
  filtered = data.filter(r=>(level==="all" || r.level===level) && (
    !q || r.han.includes(q) || (r.pinyin||"").toLowerCase().includes(q) || (r.ru||"").toLowerCase().includes(q)
  ));

  grid.innerHTML = "";
  filtered.forEach((r,idx)=>{
    const div = document.createElement("div");
    div.className="cell";
    div.setAttribute("role","listitem");
    div.dataset.level = r.level || "1";
    div.dataset.key = r.han;
    if(state.known.has(r.han)) div.dataset.known="1";
    div.textContent = r.han;
    div.addEventListener("click", ()=> openSheet(r));
    grid.appendChild(div);
  });

  // Stats
  const perLevel = [1,2,3,4,5,6].map(l=>{
    const total = data.filter(r=>String(r.level)===String(l)).length;
    const known = data.filter(r=>String(r.level)===String(l) && state.known.has(r.han)).length;
    return {l,total,known};
  });
  const totalAll = data.length;
  const knownAll = data.filter(r=>state.known.has(r.han)).length;
  stats.innerHTML = `Всего: <b>${knownAll}/${totalAll}</b> • ` + perLevel.map(x=>`HSK${x.l}: ${x.known}/${x.total}`).join(" • ");
}

function openSheet(r){
  currentItem = r;
  dHan.textContent = r.han;
  dPy.textContent = (r.pinyin && r.pinyin.trim()) ? r.pinyin : "—";
  dTr.textContent = (r.ru && r.ru.trim()) ? r.ru : "—";
  dLevel.textContent = r.level || "";
  toggleKnownBtn.textContent = state.known.has(r.han) ? "Снять отметку" : "Отметить как выучено";
  if(!sheet.open) sheet.showModal();
}

toggleKnownBtn.addEventListener("click", ()=>{
  if(!currentItem) return;
  const key = currentItem.han;
  if(state.known.has(key)) state.known.delete(key);
  else state.known.add(key);
  localStorage.setItem(STATE_KEY, JSON.stringify([...state.known]));
  sheet.close();
  render();
});
copyBtn.addEventListener("click", ()=>{
  if(!currentItem) return;
  const t = `${currentItem.han} — ${currentItem.pinyin||""} — ${currentItem.ru||""} (HSK${currentItem.level||""})`;
  navigator.clipboard.writeText(t).catch(()=>{});
});
closeBtn.addEventListener("click", ()=> sheet.close());

// Filters
levelFilter.addEventListener("change", render);
searchBox.addEventListener("input", render);

// Import/Export/Reset
document.getElementById("importCsvBtn").addEventListener("click", ()=> fileInput.click());
const fileInput = document.getElementById("fileInput");
fileInput.addEventListener("change", (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      data = parseCSV(reader.result);
      localStorage.setItem(STATE_KEY, JSON.stringify([])); // optional clear marks on new deck
      state.known = new Set();
      render();
      alert("Импортировано!");
    }catch(err){
      alert("Не удалось импортировать CSV");
    }
  };
  reader.readAsText(f, "utf-8");
});

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const payload = { known:[...state.known], ts: Date.now() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "hsk-progress.json";
  a.click();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("Сбросить все отметки?")){
    state.known = new Set();
    localStorage.removeItem(STATE_KEY);
    render();
  }
});

(function(){
  const ORIG_FETCH = window.fetch ? window.fetch.bind(window) : null;
  window.fetch = function(res, init){
    try{
      const url = (typeof res === 'string') ? res : (res && res.url) || '';
      const bare = (typeof url === 'string') ? url.split('?')[0] : '';
      if (bare && bare.endsWith && bare.endsWith('hsk.csv')){
        return Promise.resolve(new Response(sampleCSV, {status:200, headers:{'Content-Type':'text/csv'}}));
      }
    }catch(e){}
    return ORIG_FETCH ? ORIG_FETCH(res, init) : Promise.reject(new Error('fetch not available'));
  };
})();
</script>
</body>
</html>
